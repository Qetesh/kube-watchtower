---
apiVersion: v1
kind: Namespace
metadata:
  name: kube-watchtower

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kube-watchtower-config
  namespace: kube-watchtower
data:
  NOTIFICATION_URL: ""
  RUN_ONCE: "true"
  TZ: "Asia/Shanghai"
  LOG_LEVEL: "info"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-watchtower
  namespace: kube-watchtower

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kube-watchtower
rules:
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets", "daemonsets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets", "daemonsets"]
    verbs: ["update", "patch"]
  - apiGroups: ["apps"]
    resources: ["replicasets", "daemonsets"]
    verbs: ["get", "list", "delete"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kube-watchtower
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kube-watchtower
subjects:
  - kind: ServiceAccount
    name: kube-watchtower
    namespace: kube-watchtower

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: kube-watchtower
  namespace: kube-watchtower
spec:
  schedule: "0 0 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: kube-watchtower
          restartPolicy: Never
          containers:
            - name: kube-watchtower
              image: ghcr.io/qetesh/kube-watchtower:latest
              imagePullPolicy: Always
              envFrom:
                - configMapRef:
                    name: kube-watchtower-config